<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文件下载中心(BETA)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
@font-face {
  font-family: 'U5Font';
  src: url('https://github.com/EGGY-XuanQian/eggy-xuanqian.github.io/raw/refs/heads/main/Web/U5Font_Round_7744b500.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'U5Font', sans-serif !important;
}
:root {
  --google-blue: #1a73e8;
  --google-light-blue: #e8f0fe;
  --google-gray-50: #f8f9fa;
  --google-gray-100: #f1f3f4;
  --google-gray-200: #e0e0e0;
  --google-gray-500: #5f6368;
  --google-gray-700: #3c4043;
  --google-gray-800: #202124;
  --animate-duration: 0.25s;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-8px); }
}
@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes scaleOut {
  from { opacity: 1; transform: scale(1); }
  to { opacity: 0; transform: scale(0.95); }
}
body {
  background: var(--google-gray-50);
}
.nav-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
  background: white;
  border-bottom: 1px solid var(--google-gray-200);
  padding: 0 24px;
  width: 100%;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 100;
}
.brand-logo {
  font-size: 1.25rem;
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--google-gray-800);
  text-decoration: none;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  min-width: 0;
  flex-shrink: 1;
}
.brand-logo-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.brand-logo .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 32px;
  color: var(--google-blue);
  flex-shrink: 0;
}
.nav-right {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-shrink: 0;
}
.search-bar {
  display: flex;
  align-items: center;
  background: var(--google-gray-100);
  padding: 8px 16px;
  border-radius: 8px;
  width: 400px;
  transition: all var(--animate-duration) ease;
  flex-shrink: 1;
  min-width: 0;
}
.search-bar:focus-within {
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.search-bar .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  color: var(--google-gray-500);
  font-size: 20px;
  flex-shrink: 0;
}
.search-bar input {
  border: none;
  background: transparent;
  color: var(--google-gray-800);
  width: 100%;
  font-size: 14px;
  margin-left: 12px;
  outline: none;
  min-width: 0;
}
.menu-container {
  position: relative;
  flex-shrink: 0;
}
.menu-trigger {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: background var(--animate-duration) ease;
  flex-shrink: 0;
}
.menu-trigger:hover {
  background: var(--google-gray-100);
}
.menu-trigger .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 24px;
  color: var(--google-gray-700);
}
.dropdown-menu {
  position: absolute;
  top: 56px;
  right: 0;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.15);
  width: 240px;
  opacity: 0;
  transform: scale(0.95);
  transform-origin: top right;
  pointer-events: none;
  z-index: 1000;
  border: 1px solid var(--google-gray-200);
  overflow: hidden;
}
.dropdown-menu.show {
  opacity: 1;
  transform: scale(1);
  pointer-events: auto;
  animation: scaleIn var(--animate-duration) ease forwards;
}
.dropdown-menu.hiding {
  animation: scaleOut var(--animate-duration) ease forwards;
}
.menu-section {
  padding: 12px 0;
  border-bottom: 1px solid var(--google-gray-100);
}
.menu-section:last-child {
  border-bottom: none;
}
.menu-section-title {
  padding: 0 16px 8px;
  font-size: 12px;
  color: var(--google-gray-500);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.menu-item {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.2s ease;
  font-size: 14px;
  color: var(--google-gray-700);
}
.menu-item:hover {
  background: var(--google-gray-50);
}
.menu-item.active {
  color: var(--google-blue);
  background: var(--google-light-blue);
}
.menu-item .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 20px;
}
.path-bar {
  margin-top: 64px;
  padding: 16px 24px;
  background: white;
  border-bottom: 1px solid var(--google-gray-200);
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--google-gray-100);
  border-radius: 4px;
  cursor: pointer;
  transition: background var(--animate-duration) ease;
  font-size: 14px;
  color: var(--google-gray-700);
  flex-shrink: 0;
}
.back-btn:hover {
  background: var(--google-gray-200);
}
.back-btn .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 18px;
}
.current-path {
  font-size: 14px;
  color: var(--google-gray-700);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.content-area {
  padding: 24px;
  min-height: calc(100vh - 120px);
}
.view-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
}
.list-view {
  display: flex;
  flex-direction: column;
  gap: 1px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--google-gray-200);
}
.file-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  border: 1px solid var(--google-gray-200);
  cursor: pointer;
  transition: all var(--animate-duration) ease;
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 180px;
  position: relative;
  animation: slideIn var(--animate-duration) ease forwards;
  opacity: 0;
}
.file-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border-color: var(--google-blue);
}
.file-card.dir {
  border-color: var(--google-light-blue);
}
.file-icon-container {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: var(--google-light-blue);
  flex-shrink: 0;
}
.file-card.dir .file-icon-container {
  background: #f0f7ff;
}
.file-icon {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 28px;
  color: var(--google-blue);
}
.file-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 0;
}
.file-name {
  font-size: 14px;
  color: var(--google-gray-800);
  font-weight: 500;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-break: break-all;
}
.file-meta {
  font-size: 12px;
  color: var(--google-gray-500);
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-top: auto;
  width: 100%;
}
.file-meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  overflow: hidden;
}
.file-meta-item span:last-child {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.file-meta-item .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 14px;
  flex-shrink: 0;
}
.list-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: white;
  border-bottom: 1px solid var(--google-gray-100);
  cursor: pointer;
  transition: background var(--animate-duration) ease;
  animation: slideIn var(--animate-duration) ease forwards;
  opacity: 0;
  min-width: 0;
}
.list-item:hover {
  background: var(--google-gray-50);
}
.list-item .file-icon-container {
  width: 36px;
  height: 36px;
  margin-right: 16px;
  flex-shrink: 0;
}
.list-item .file-name {
  flex: 1;
  -webkit-line-clamp: 1;
  min-width: 0;
}
.list-item .file-meta {
  margin-top: 0;
  margin-left: 16px;
  min-width: 160px;
  flex-direction: row;
  gap: 16px;
  flex-shrink: 0;
}
.initial-loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 1;
  transition: opacity 0.3s ease;
}
.initial-loading.hidden {
  opacity: 0;
  pointer-events: none;
}
.loading-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 80px 20px;
  color: var(--google-gray-500);
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--google-gray-100);
  border-top: 3px solid var(--google-blue);
  border-radius: 50%;
  margin: 0 auto 16px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 80px 20px;
  color: var(--google-gray-500);
}
.empty-state .material-symbols-outlined {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.context-menu {
  position: absolute;
  background: white;
  border: 1px solid var(--google-gray-200);
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.15);
  padding: 8px 0;
  width: 180px;
  display: none;
  z-index: 1000;
}
.context-menu.show {
  display: block;
  animation: scaleIn var(--animate-duration) ease forwards;
}
.context-menu.hiding {
  display: block;
  animation: scaleOut var(--animate-duration) ease forwards;
}
.context-menu-item {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.2s ease;
  font-size: 14px;
  color: var(--google-gray-700);
}
.context-menu-item:hover {
  background: var(--google-gray-50);
}
.context-menu-item .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 18px;
  color: var(--google-gray-600);
}
.preview-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn var(--animate-duration) ease;
}
.preview-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
  animation: scaleIn var(--animate-duration) ease;
}
.preview-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--google-gray-200);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.preview-title {
  font-size: 18px;
  color: var(--google-gray-800);
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.preview-close {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: background var(--animate-duration) ease;
  flex-shrink: 0;
}
.preview-close:hover {
  background: var(--google-gray-100);
}
.preview-close .material-symbols-outlined {
  font-family: 'Material Symbols Outlined' !important;
  font-size: 20px;
  color: var(--google-gray-700);
}
.preview-body {
  padding: 24px;
  max-height: calc(90vh - 80px);
  overflow: auto;
}
.preview-image {
  max-width: 100%;
  max-height: 70vh;
  display: block;
  margin: 0 auto;
}
.preview-text {
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 14px;
  line-height: 1.6;
  color: var(--google-gray-800);
}
.preview-unsupported {
  text-align: center;
  padding: 40px 20px;
  color: var(--google-gray-500);
}
.preview-unsupported .material-symbols-outlined {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}
@media (max-width: 768px) {
  .nav-wrapper {
    padding: 0 16px;
    height: 56px;
  }
  .brand-logo {
    font-size: 1.1rem;
    gap: 8px;
  }
  .brand-logo .material-symbols-outlined {
    font-size: 28px;
  }
  .search-bar {
    width: 180px;
    padding: 6px 12px;
  }
  .path-bar {
    margin-top: 56px;
    padding: 12px 16px;
  }
  .content-area {
    padding: 16px;
  }
  .view-container {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
  }
  .file-card {
    height: 160px;
    padding: 12px;
  }
  .file-icon-container {
    width: 40px;
    height: 40px;
  }
  .file-icon {
    font-size: 24px;
  }
  .list-item .file-meta {
    min-width: 120px;
    gap: 8px;
  }
}
@media (max-width: 440px) {
  .brand-logo-text {
    max-width: 120px;
  }
  .search-bar {
    width: 140px;
  }
  .menu-trigger {
    width: 40px;
    height: 40px;
  }
}
</style>
</head>
<body>
<div class="initial-loading" id="initialLoading">
  <div class="loading-state">
    <div class="loading-spinner"></div>
    <p>加载中...</p>
  </div>
</div>
<nav>
<div class="nav-wrapper">
<a href="#" class="brand-logo">
<span class="material-symbols-outlined">folder</span>
<span class="brand-logo-text">文件下载中心</span>
</a>
<div class="nav-right">
<div class="search-bar">
<span class="material-symbols-outlined">search</span>
<input type="text" placeholder="搜索文件" id="searchInput">
</div>
<div class="menu-container">
<div class="menu-trigger" id="menuTrigger">
<span class="material-symbols-outlined">more_vert</span>
</div>
<div class="dropdown-menu" id="dropdownMenu">
<div class="menu-section">
<div class="menu-section-title">文件视图</div>
<div class="menu-item active" data-view="grid">
<span class="material-symbols-outlined">grid_view</span>
<span>网格视图</span>
</div>
<div class="menu-item" data-view="list">
<span class="material-symbols-outlined">view_list</span>
<span>列表视图</span>
</div>
</div>
<div class="menu-section">
<div class="menu-section-title">文件排序</div>
<div class="menu-item" data-sort="size">
<span class="material-symbols-outlined">sort</span>
<span>大小排序</span>
</div>
<div class="menu-item active" data-sort="name">
<span class="material-symbols-outlined">sort_by_alpha</span>
<span>名称排序</span>
</div>
<div class="menu-item" data-sort="type">
<span class="material-symbols-outlined">category</span>
<span>类型排序</span>
</div>
</div>
</div>
</div>
</div>
</div>
</nav>
<div class="path-bar" id="pathBar">
<div class="back-btn" id="backBtn" style="display: none;">
<span class="material-symbols-outlined">arrow_back</span>
<span>返回</span>
</div>
<span class="current-path" id="currentPath"></span>
</div>
<main class="content-area">
<div id="viewContainer" class="view-container"></div>
</main>
<div class="context-menu" id="contextMenu">
<div class="context-menu-item" onclick="previewCurrentFile()">
<span class="material-symbols-outlined">preview</span>
<span>预览文件</span>
</div>
<div class="context-menu-item" onclick="downloadCurrentFile()">
<span class="material-symbols-outlined">download</span>
<span>下载文件</span>
</div>
<div class="context-menu-item" onclick="copyFileName()">
<span class="material-symbols-outlined">content_copy</span>
<span>复制名称</span>
</div>
</div>
<div class="preview-modal" id="previewModal">
<div class="preview-content">
<div class="preview-header">
<div class="preview-title" id="previewTitle"></div>
<div class="preview-close" onclick="closePreview()">
<span class="material-symbols-outlined">close</span>
</div>
</div>
<div class="preview-body" id="previewBody"></div>
</div>
</div>
<script>
const GITHUB_CONFIG = {
  owner: "EGGY-XuanQian",
  repo: "eggy-xuanqian.github.io",
  path: "Code",
  branch: "main"
};
let currentFiles = [];
let currentPath = "";
let pathHistory = [];
let isLoading = false;
let currentView = "grid";
let currentSort = "name";
let currentFile = null;
let animateLock = false;
let lastMenuHideTime = 0;
const viewContainer = document.getElementById("viewContainer");
const searchInput = document.getElementById("searchInput");
const menuTrigger = document.getElementById("menuTrigger");
const dropdownMenu = document.getElementById("dropdownMenu");
const menuItems = document.querySelectorAll(".menu-item");
const backBtn = document.getElementById("backBtn");
const currentPathEl = document.getElementById("currentPath");
const contextMenu = document.getElementById("contextMenu");
const previewModal = document.getElementById("previewModal");
const initialLoading = document.getElementById("initialLoading");
function init() {
  setupEventListeners();
  fetchFiles();
}
function setupEventListeners() {
  menuTrigger.addEventListener("click", function(e) {
    e.stopPropagation();
    toggleDropdownMenu();
  });
  document.addEventListener("click", function(e) {
    if (!menuTrigger.contains(e.target) && !dropdownMenu.contains(e.target)) {
      hideDropdownMenu();
    }
    hideContextMenu();
  });
  menuItems.forEach(item => {
    item.addEventListener("click", function() {
      const view = this.dataset.view;
      const sort = this.dataset.sort;
      if (view && currentView !== view) {
        setActiveView(view);
      }
      if (sort && currentSort !== sort) {
        setActiveSort(sort);
      }
      hideDropdownMenu();
    });
  });
  searchInput.addEventListener("input", function() {
    filterFiles(this.value.trim().toLowerCase());
  });
  backBtn.addEventListener("click", function() {
    if (pathHistory.length > 0 && !animateLock) {
      navigateBack();
    }
  });
  document.addEventListener("contextmenu", function(e) {
    const target = e.target.closest(".file-card, .list-item");
    if (target) {
      e.preventDefault();
    }
  });
  document.addEventListener("click", function(e) {
    if (!contextMenu.contains(e.target)) {
      hideContextMenu();
    }
  });
}
function toggleDropdownMenu() {
  if (dropdownMenu.classList.contains("show")) {
    hideDropdownMenu();
  } else {
    showDropdownMenu();
  }
}
function showDropdownMenu() {
  dropdownMenu.classList.remove("hiding");
  dropdownMenu.classList.add("show");
}
function hideDropdownMenu() {
  if (dropdownMenu.classList.contains("show")) {
    dropdownMenu.classList.remove("show");
    dropdownMenu.classList.add("hiding");
    setTimeout(() => {
      dropdownMenu.classList.remove("hiding");
    }, 250);
  }
}
function setActiveView(view) {
  if (currentView === view || animateLock) return;
  
  animateTransition(() => {
    currentView = view;
    document.querySelectorAll('[data-view]').forEach(item => {
      item.classList.toggle("active", item.dataset.view === view);
    });
    renderFiles(currentFiles);
  });
}
function setActiveSort(sort) {
  if (currentSort === sort || animateLock) return;
  
  currentSort = sort;
  document.querySelectorAll('[data-sort]').forEach(item => {
    item.classList.toggle("active", item.dataset.sort === sort);
  });
  sortFiles();
}
function animateTransition(callback) {
  if (animateLock) return;
  animateLock = true;
  
  viewContainer.style.animation = "slideOut var(--animate-duration) ease forwards";
  
  setTimeout(() => {
    callback();
    viewContainer.style.animation = "slideIn var(--animate-duration) ease forwards";
    setTimeout(() => {
      viewContainer.style.animation = "";
      animateLock = false;
    }, 250);
  }, 250);
}
async function fetchFiles(pushHistory = true) {
  if (isLoading) return;
  isLoading = true;
  showLoading();
  
  try {
    const targetPath = currentPath ? `${GITHUB_CONFIG.path}/${currentPath}` : GITHUB_CONFIG.path;
    const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${targetPath}?ref=${GITHUB_CONFIG.branch}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (pushHistory && currentPath !== "") {
      const lastHistory = pathHistory[pathHistory.length - 1];
      if (lastHistory !== currentPath) {
        pathHistory.push(currentPath);
      }
    }
    
    currentFiles = data.map(item => ({
      name: item.name,
      type: item.type,
      size: item.size || 0,
      sizeBytes: item.size,
      downloadUrl: item.download_url,
      lastModified: item.last_modified || item.git_last_modified || new Date().toISOString(),
      path: item.path
    }));
    
    sortFiles();
    updatePathDisplay();
    
    setTimeout(() => {
      hideInitialLoading();
    }, 300);
  } catch (error) {
    showError();
    console.error(error);
    setTimeout(() => {
      hideInitialLoading();
    }, 300);
  } finally {
    isLoading = false;
  }
}
function hideInitialLoading() {
  initialLoading.classList.add("hidden");
  setTimeout(() => {
    initialLoading.style.display = "none";
  }, 300);
}
function navigateBack() {
  if (pathHistory.length === 0 || animateLock) return;
  
  animateTransition(() => {
    const previousPath = pathHistory.pop();
    currentPath = previousPath || "";
    fetchFiles(false);
    updatePathDisplay();
  });
}
function sortFiles() {
  currentFiles.sort((a, b) => {
    if (a.type !== b.type) {
      return a.type === "dir" ? -1 : 1;
    }
    if (currentSort === "name") {
      return a.name.localeCompare(b.name);
    } else if (currentSort === "size") {
      return (b.sizeBytes || 0) - (a.sizeBytes || 0);
    } else if (currentSort === "type") {
      const extA = getFileExtension(a.name);
      const extB = getFileExtension(b.name);
      return extA.localeCompare(extB);
    }
    return 0;
  });
  renderFiles(currentFiles);
}
function getFileExtension(filename) {
  return filename.split(".").pop().toLowerCase() || "";
}
function getFileIcon(file) {
  if (file.type === "dir") return "folder";
  const ext = getFileExtension(file.name);
  const imageExts = ["jpg", "jpeg", "png", "gif", "bmp", "webp", "svg", "ico"];
  const codeExts = ["js", "css", "html", "htm", "json", "xml", "py", "java", "cpp", "c", "php", "go", "ts", "jsx", "tsx", "sh", "bat", "md"];
  const docExts = ["pdf", "doc", "docx", "xls", "xlsx", "ppt", "pptx", "txt", "rtf"];
  const mediaExts = ["mp4", "avi", "mov", "mkv", "mp3", "wav", "flac", "ogg", "aac"];
  const archiveExts = ["zip", "rar", "7z", "tar", "gz", "bz2"];
  
  if (imageExts.includes(ext)) return "image";
  if (codeExts.includes(ext)) return "code";
  if (docExts.includes(ext)) return "description";
  if (mediaExts.includes(ext)) {
    if (["mp4", "avi", "mov", "mkv"].includes(ext)) return "movie";
    if (["mp3", "wav", "flac", "ogg", "aac"].includes(ext)) return "audio_file";
  }
  if (archiveExts.includes(ext)) return "folder_zip";
  return "insert_drive_file";
}
function filterFiles(keyword) {
  if (!keyword) {
    renderFiles(currentFiles);
    return;
  }
  const filtered = currentFiles.filter(file => 
    file.name.toLowerCase().includes(keyword)
  );
  renderFiles(filtered);
}
function renderFiles(files) {
  if (files.length === 0) {
    viewContainer.innerHTML = `
      <div class="empty-state">
        <span class="material-symbols-outlined">folder_off</span>
        <p>没有找到文件</p>
      </div>
    `;
    return;
  }
  
  if (currentView === "grid") {
    renderGridView(files);
  } else {
    renderListView(files);
  }
}
function renderGridView(files) {
  viewContainer.className = "view-container";
  viewContainer.innerHTML = files.map((file, index) => {
    const isDir = file.type === "dir";
    const displaySize = isDir ? "" : formatSize(file.size);
    const displayTime = formatDate(file.lastModified);
    
    return `
    <div class="file-card ${isDir ? "dir" : ""}" 
         style="animation-delay: ${index * 30}ms"
         onclick="handleFileClick('${file.type}', '${file.name}')"
         oncontextmenu="showContextMenu(event, ${JSON.stringify(file).replace(/"/g, '&quot;')})">
      <div class="file-icon-container">
        <span class="material-symbols-outlined file-icon">${getFileIcon(file)}</span>
      </div>
      <div class="file-info">
        <div class="file-name" title="${file.name}">${file.name}</div>
        <div class="file-meta">
          ${!isDir ? `
          <div class="file-meta-item">
            <span class="material-symbols-outlined">storage</span>
            <span title="${displaySize}">${displaySize}</span>
          </div>
          ` : ""}
          <div class="file-meta-item">
            <span class="material-symbols-outlined">schedule</span>
            <span title="${displayTime}">${displayTime}</span>
          </div>
        </div>
      </div>
    </div>
  `}).join("");
}
function renderListView(files) {
  viewContainer.className = "list-view";
  viewContainer.innerHTML = files.map((file, index) => {
    const isDir = file.type === "dir";
    const displaySize = isDir ? "" : formatSize(file.size);
    const displayTime = formatDate(file.lastModified);
    
    return `
    <div class="list-item" 
         style="animation-delay: ${index * 20}ms"
         onclick="handleFileClick('${file.type}', '${file.name}')"
         oncontextmenu="showContextMenu(event, ${JSON.stringify(file).replace(/"/g, '&quot;')})">
      <div class="file-icon-container">
        <span class="material-symbols-outlined file-icon">${getFileIcon(file)}</span>
      </div>
      <div class="file-name" title="${file.name}">${file.name}</div>
      <div class="file-meta">
        ${!isDir ? `
        <div class="file-meta-item">
          <span class="material-symbols-outlined">storage</span>
          <span title="${displaySize}">${displaySize}</span>
        </div>
        ` : ""}
        <div class="file-meta-item">
          <span class="material-symbols-outlined">schedule</span>
          <span title="${displayTime}">${displayTime}</span>
        </div>
      </div>
    </div>
  `}).join("");
}
function handleFileClick(type, name) {
  if (type === "dir") {
    animateTransition(() => {
      currentPath = currentPath ? `${currentPath}/${name}` : name;
      fetchFiles();
    });
  }
}
function showContextMenu(e, file) {
  e.preventDefault();
  
  if (file.type !== "file") {
    return;
  }
  
  const now = Date.now();
  if (now - lastMenuHideTime < 100) {
    return;
  }
  
  hideContextMenu();
  setTimeout(() => {
    currentFile = file;
    contextMenu.classList.remove("hiding");
    contextMenu.classList.add("show");
    
    const x = Math.min(e.pageX, window.innerWidth - 200);
    const y = Math.min(e.pageY, window.innerHeight - 150);
    contextMenu.style.left = x + "px";
    contextMenu.style.top = y + "px";
  }, 10);
}
function hideContextMenu() {
  if (contextMenu.classList.contains("show")) {
    contextMenu.classList.remove("show");
    contextMenu.classList.add("hiding");
    lastMenuHideTime = Date.now();
    setTimeout(() => {
      contextMenu.classList.remove("hiding");
      contextMenu.style.display = "none";
    }, 250);
  }
}
function previewCurrentFile() {
  if (!currentFile || currentFile.type !== "file") return;
  
  const modal = document.getElementById("previewModal");
  const title = document.getElementById("previewTitle");
  const body = document.getElementById("previewBody");
  
  title.textContent = currentFile.name;
  const ext = getFileExtension(currentFile.name);
  const imageExts = ["jpg", "jpeg", "png", "gif", "bmp", "webp", "svg", "ico"];
  const textExts = ["txt", "md", "js", "css", "html", "htm", "json", "xml", "py", "java", "cpp", "c", "php", "go", "ts", "jsx", "tsx", "sh", "bat"];
  
  if (imageExts.includes(ext)) {
    body.innerHTML = `<img src="${currentFile.downloadUrl}" class="preview-image" alt="${currentFile.name}" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'preview-unsupported\'><span class=\'material-symbols-outlined\'>error</span><p>无法加载图片</p></div>';">`;
  } else if (textExts.includes(ext)) {
    fetch(currentFile.downloadUrl)
      .then(response => {
        if (!response.ok) throw new Error();
        return response.text();
      })
      .then(text => {
        body.innerHTML = `<pre class="preview-text">${escapeHtml(text)}</pre>`;
      })
      .catch(() => {
        body.innerHTML = `
          <div class="preview-unsupported">
            <span class="material-symbols-outlined">error</span>
            <p>无法加载文件内容</p>
          </div>
        `;
      });
  } else {
    body.innerHTML = `
      <div class="preview-unsupported">
        <span class="material-symbols-outlined">insert_drive_file</span>
        <p>不支持预览此文件类型</p>
      </div>
    `;
  }
  modal.style.display = "flex";
  hideContextMenu();
}
function closePreview() {
  previewModal.style.display = "none";
}
function downloadCurrentFile() {
  if (currentFile && currentFile.type === "file" && currentFile.downloadUrl) {
    const a = document.createElement("a");
    a.href = currentFile.downloadUrl;
    a.download = currentFile.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  hideContextMenu();
}
function copyFileName() {
  if (currentFile) {
    navigator.clipboard.writeText(currentFile.name);
  }
  hideContextMenu();
}
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}
function formatSize(bytes) {
  if (!bytes) return "0 B";
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
  if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + " MB";
  return (bytes / (1024 * 1024 * 1024)).toFixed(1) + " GB";
}
function formatDate(dateString) {
  if (!dateString) return "未知时间";
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return "未知时间";
    }
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    const diffWeeks = Math.floor(diffDays / 7);
    const diffMonths = Math.floor(diffDays / 30);
    
    if (diffMins < 1) return "刚刚";
    if (diffMins < 60) return `${diffMins}分钟前`;
    if (diffHours < 24) return `${diffHours}小时前`;
    if (diffDays < 7) return `${diffDays}天前`;
    if (diffWeeks < 4) return `${diffWeeks}周前`;
    if (diffMonths < 12) return `${diffMonths}个月前`;
    return `${Math.floor(diffDays / 365)}年前`;
  } catch (error) {
    return "未知时间";
  }
}
function updatePathDisplay() {
  backBtn.style.display = pathHistory.length > 0 ? "flex" : "none";
  currentPathEl.textContent = currentPath ? `/${currentPath}` : "/";
}
function showLoading() {
  viewContainer.innerHTML = `
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>加载中...</p>
    </div>
  `;
}
function showError() {
  viewContainer.innerHTML = `
    <div class="empty-state">
      <span class="material-symbols-outlined">error</span>
      <p>加载失败，请稍后重试</p>
    </div>
  `;
}
window.onload = init;
</script>
</body>
</html>
